[
  {
    "number": 89,
    "title": "uni-meter does not work when at startup the mqtt input device was not available",
    "created_at": "2025-03-31T17:16:26Z",
    "closed_at": "2025-04-01T02:29:33Z",
    "commit_id": "62e71362344f2b2ea29f6084d9e81634d0e9782c",
    "labels": [
      "bug"
    ],
    "url": "https://github.com/sdeigm/uni-meter/issues/89",
    "body": "uni-meter-1.1.3\n\nHaving in file `/etc/uni-meter.conf` the following MQTT input source, where 192.168.1.4:1883 is the Home Assistant MQTT broker:\n\n```\n  input-devices {\n    mqtt {\n      url = \"tcp://192.168.1.4:1883\"\n      username = \"mqttclient\"\n      password = \"****\"\n\n      power-phase-mode = \"mono-phase\"\n      energy-phase-mode = \"mono-phase\"\n\n      channels = [{\n        type = \"json\"\n        topic = \"tele/tasmota_FA33FC/SENSOR\"\n        channel = \"power-total\"\n        json-path = \"$..power\"\n      },{\n        type = \"json\"\n        topic = \"tele/tasmota_FA33FC/SENSOR\"\n        channel = \"energy-consumption-total\"\n        json-path = \"$..energy_sum\"\n      },{\n        type = \"json\"\n        topic = \"tele/tasmota_FA33FC/SENSOR\"\n        channel = \"energy-production-total\"\n        json-path = \"$..energy_supply\"\n      }]\n    }\n  }\n```\n\nWhen uni-meter systemd unit is started before the Home Assistant MQTT broker is up and running, then uni-meter will not start working at all, even not when the MQTT broker becomes available.\n\nIt would be better if uni-meter would try every e.g. 1 min again, and start working as soon as the input source becomes available.\n\nCurrently, the solution is to restart uni-meter after mqtt broker is running.",
    "comments_url": "https://api.github.com/repos/sdeigm/uni-meter/issues/89/comments",
    "author": "Gitsarry",
    "comments": [
      {
        "user": "sdeigm",
        "created_at": "2025-04-01T02:26:10Z",
        "body": "Can confirm the problem. In theory uni-meter is already designed to always retry failed operations. Here I didn't reinitialized the underlyling MQTT library correctly."
      },
      {
        "user": "Gitsarry",
        "created_at": "2025-04-01T03:53:32Z",
        "body": "Thank you very much for your work "
      },
      {
        "user": "Gitsarry",
        "created_at": "2025-04-03T04:22:46Z",
        "body": "Have just tested with 1.1.4 and can confirm issue is fixed:\n\n- stop uni-meter\n- stop Home Assistant and with it the HA MQTT broker, which is input-source of uni-meter\n- start uni-meter\n- wait until log entry `MQTT stream failed: MqttException` occurs three times in a row\n- start Home Assistant\n- log entry `MQTT stream connected` shows up and uni-meter is working\n\n\n```\n25-04-03 06:10:58.007 INFO  uni-meter                - ##################################################################\n25-04-03 06:10:58.012 INFO  uni-meter                - # Universal electric meter converter 1.1.4 (2025-04-01 05:12:23) #\n25-04-03 06:10:58.012 INFO  uni-meter                - ##################################################################\n25-04-03 06:10:58.012 INFO  uni-meter                - initializing actor system\n25-04-03 06:10:58.781 INFO  org.apache.pekko.event.slf4j.Slf4jLogger - Slf4jLogger started\n25-04-03 06:10:59.252 INFO  uni-meter.controller     - creating ShellyPro3EM output device\n25-04-03 06:10:59.277 INFO  uni-meter.controller     - creating MQTT input device\n25-04-03 06:10:59.598 INFO  uni-meter.input          - subscribing to topic: tele/tasmota_FA33FC/SENSOR\n25-04-03 06:10:59.885 ERROR uni-meter.input          - MQTT stream failed: MqttException\n25-04-03 06:11:00.474 INFO  uni-meter.http.port-80   - HTTP server is listening on /[0:0:0:0:0:0:0:0]:80\n25-04-03 06:11:17.980 ERROR uni-meter.input          - MQTT stream failed: MqttException\n25-04-03 06:11:50.041 ERROR uni-meter.input          - MQTT stream failed: MqttException\n25-04-03 06:12:52.478 ERROR uni-meter.input          - MQTT stream failed: MqttException\n25-04-03 06:13:52.871 INFO  uni-meter.input          - MQTT stream connected\n\n```"
      }
    ],
    "satisfaction_conditions": [
      "A mechanism for uni-meter to automatically reconnect to MQTT broker when it becomes available",
      "Resilience to input device unavailability at startup",
      "Appropriate error handling with retry capability",
      "No manual intervention required after input source becomes available"
    ],
    "_classification": {
      "category": "Does not need build environment",
      "timestamp": "2025-04-14 00:59:47"
    }
  }
]