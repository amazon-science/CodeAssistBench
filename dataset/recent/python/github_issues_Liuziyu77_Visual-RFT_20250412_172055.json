[
  {
    "number": 106,
    "title": "Error building extension 'fused_adam'",
    "created_at": "2025-03-16T13:51:47Z",
    "closed_at": "2025-03-25T15:38:11Z",
    "commit_id": "384f47c1eb66f2fe76df5d330c11b9b481dd1791",
    "labels": [],
    "url": "https://github.com/Liuziyu77/Visual-RFT/issues/106",
    "body": "\nDescribe the bug\nerror: #error \"You're trying to build PyTorch with a too old version of GCC. We need GCC 9 or later.\"\n\nBuilding extension module fused_adam...\nAllowing ninja to set a default number of workers... (overridable by setting the environment variable MAX_JOBS=N)\n[1/3] /usr/local/cuda/bin/nvcc --generate-dependencies-with-compile --dependency-output multi_tensor_adam.cuda.o.d -ccbin /usr/local/gcc/bin/gcc -DTORCH_EXTENSION_NAME=fused_adam -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"gcc\" -DPYBIND11_STDLIB=\"libstdcpp\" -DPYBIND11_BUILD_ABI=\"cxxabi1011\" -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/includes -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/api/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/TH -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/THC -isystem /usr/local/cuda/include -isystem /dockerdata/lujunda/env/rft/include/python3.12 -D_GLIBCXX_USE_CXX11_ABI=0 -D__CUDA_NO_HALF_OPERATORS -D__CUDA_NO_HALF_CONVERSIONS_ -D__CUDA_NO_BFLOAT16_CONVERSIONS__ -D__CUDA_NO_HALF2_OPERATORS__ --expt-relaxed-constexpr -gencode=arch=compute_80,code=compute_80 -gencode=arch=compute_80,code=sm_80 --compiler-options '-fPIC' -O3 -DVERSION_GE_1_1 -DVERSION_GE_1_3 -DVERSION_GE_1_5 -lineinfo --use_fast_math -gencode=arch=compute_80,code=sm_80 -gencode=arch=compute_80,code=compute_80 -DBF16_AVAILABLE -U__CUDA_NO_BFLOAT16_OPERATORS__ -U__CUDA_NO_BFLOAT162_OPERATORS__ -U__CUDA_NO_BFLOAT16_CONVERSIONS__ -std=c++17 -c /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam/multi_tensor_adam.cu -o multi_tensor_adam.cuda.o\nFAILED: multi_tensor_adam.cuda.o\n/usr/local/cuda/bin/nvcc --generate-dependencies-with-compile --dependency-output multi_tensor_adam.cuda.o.d -ccbin /usr/local/gcc/bin/gcc -DTORCH_EXTENSION_NAME=fused_adam -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"gcc\" -DPYBIND11_STDLIB=\"libstdcpp\" -DPYBIND11_BUILD_ABI=\"cxxabi1011\" -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/includes -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/api/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/TH -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/THC -isystem /usr/local/cuda/include -isystem /dockerdata/lujunda/env/rft/include/python3.12 -D_GLIBCXX_USE_CXX11_ABI=0 -D__CUDA_NO_HALF_OPERATORS -D__CUDA_NO_HALF_CONVERSIONS_ -D__CUDA_NO_BFLOAT16_CONVERSIONS__ -D__CUDA_NO_HALF2_OPERATORS__ --expt-relaxed-constexpr -gencode=arch=compute_80,code=compute_80 -gencode=arch=compute_80,code=sm_80 --compiler-options '-fPIC' -O3 -DVERSION_GE_1_1 -DVERSION_GE_1_3 -DVERSION_GE_1_5 -lineinfo --use_fast_math -gencode=arch=compute_80,code=sm_80 -gencode=arch=compute_80,code=compute_80 -DBF16_AVAILABLE -U__CUDA_NO_BFLOAT16_OPERATORS__ -U__CUDA_NO_BFLOAT162_OPERATORS__ -U__CUDA_NO_BFLOAT16_CONVERSIONS__ -std=c++17 -c /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam/multi_tensor_adam.cu -o multi_tensor_adam.cuda.o\nIn file included from /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/c10/util/CallOnce.h:8,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/ATen/Context.h:22,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/ATen/ATen.h:7,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam/multi_tensor_adam.cu:11:\n/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/c10/util/C++17.h:13:2: error: #error \"You're trying to build PyTorch with a too old version of GCC. We need GCC 9 or later.\"\n#error\n^~~~~\n[2/3] /usr/local/gcc/bin/g++ -MMD -MF fused_adam_frontend.o.d -DTORCH_EXTENSION_NAME=fused_adam -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1011\" -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/includes -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/api/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/TH -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/THC -isystem /usr/local/cuda/include -isystem /dockerdata/lujunda/env/rft/include/python3.12 -D_GLIBCXX_USE_CXX11_ABI=0 -fPIC -std=c++17 -O3 -std=c++17 -g -Wno-reorder -DVERSION_GE_1_1 -DVERSION_GE_1_3 -DVERSION_GE_1_5 -DBF16_AVAILABLE -c /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam/fused_adam_frontend.cpp -o fused_adam_frontend.o\nFAILED: fused_adam_frontend.o\n/usr/local/gcc/bin/g++ -MMD -MF fused_adam_frontend.o.d -DTORCH_EXTENSION_NAME=fused_adam -DTORCH_API_INCLUDE_EXTENSION_H -DPYBIND11_COMPILER_TYPE=\"_gcc\" -DPYBIND11_STDLIB=\"_libstdcpp\" -DPYBIND11_BUILD_ABI=\"_cxxabi1011\" -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/includes -I/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/api/include -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/TH -isystem /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/THC -isystem /usr/local/cuda/include -isystem /dockerdata/lujunda/env/rft/include/python3.12 -D_GLIBCXX_USE_CXX11_ABI=0 -fPIC -std=c++17 -O3 -std=c++17 -g -Wno-reorder -DVERSION_GE_1_1 -DVERSION_GE_1_3 -DVERSION_GE_1_5 -DBF16_AVAILABLE -c /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam/fused_adam_frontend.cpp -o fused_adam_frontend.o\nIn file included from /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/ATen/core/TensorBase.h:14,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/ATen/core/TensorBody.h:38,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/ATen/core/Tensor.h:3,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/ATen/Tensor.h:3,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/autograd/function_hook.h:3,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/autograd/cpp_hook.h:2,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/autograd/variable.h:6,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/autograd/autograd.h:3,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/api/include/torch/autograd.h:3,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/csrc/api/include/torch/all.h:7,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/torch/extension.h:5,\nfrom /dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/csrc/adam/fused_adam_frontend.cpp:6:\n/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/include/c10/util/C++17.h:13:2: error: #error \"You're trying to build PyTorch with a too old version of GCC. We need GCC 9 or later.\"\n#error\n^~~~~\nninja: build stopped: subcommand failed.\n[rank0]: Traceback (most recent call last):\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/utils/cpp_extension.py\", line 2104, in _run_ninja_build\n[rank0]: subprocess.run(\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/subprocess.py\", line 573, in run\n[rank0]: raise CalledProcessError(retcode, process.args,\n[rank0]: subprocess.CalledProcessError: Command '['ninja', '-v']' returned non-zero exit status 1.\n\n[rank0]: The above exception was the direct cause of the following exception:\n\n[rank0]: Traceback (most recent call last):\n[rank0]: File \"/apdcephfs_cq8/share_1534723/jackjdlu/ms_swift_custom/Visual-RFT/src/virft/src/open_r1/grpo_classification.py\", line 199, in\n[rank0]: main(script_args, training_args, model_args)\n[rank0]: File \"/apdcephfs_cq8/share_1534723/jackjdlu/ms_swift_custom/Visual-RFT/src/virft/src/open_r1/grpo_classification.py\", line 175, in main\n[rank0]: trainer = trainer_cls(\n[rank0]: ^^^^^^^^^^^^\n[rank0]: File \"/apdcephfs_cq8/share_1534723/jackjdlu/ms_swift_custom/Visual-RFT/src/virft/src/open_r1/trainer/grpo_trainer.py\", line 338, in init\n[rank0]: self.ref_model = prepare_deepspeed(self.ref_model, self.accelerator)\n[rank0]: ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/trl/models/utils.py\", line 254, in prepare_deepspeed\n[rank0]: model, *_ = deepspeed.initialize(model=model, config=config_kwargs)\n[rank0]: ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/init.py\", line 193, in initialize\n[rank0]: engine = DeepSpeedEngine(args=args,\n[rank0]: ^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/engine.py\", line 317, in init\n[rank0]: self._configure_optimizer(optimizer, model_parameters)\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/engine.py\", line 1359, in _configure_optimizer\n[rank0]: basic_optimizer = self._configure_basic_optimizer(model_parameters)\n[rank0]: ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/engine.py\", line 1436, in _configure_basic_optimizer\n[rank0]: optimizer = FusedAdam(\n[rank0]: ^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/adam/fused_adam.py\", line 94, in init\n[rank0]: fused_adam_cuda = FusedAdamBuilder().load()\n[rank0]: ^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/op_builder/builder.py\", line 540, in load\n[rank0]: return self.jit_load(verbose)\n[rank0]: ^^^^^^^^^^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/ops/op_builder/builder.py\", line 587, in jit_load\n[rank0]: op_module = load(name=self.name,\n[rank0]: ^^^^^^^^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/utils/cpp_extension.py\", line 1314, in load\n[rank0]: return _jit_compile(\n[rank0]: ^^^^^^^^^^^^^\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/utils/cpp_extension.py\", line 1721, in _jit_compile\n[rank0]: _write_ninja_file_and_build_library(\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/utils/cpp_extension.py\", line 1833, in _write_ninja_file_and_build_library\n[rank0]: _run_ninja_build(\n[rank0]: File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/utils/cpp_extension.py\", line 2120, in _run_ninja_build\n[rank0]: raise RuntimeError(message) from e\n[rank0]: RuntimeError: Error building extension 'fused_adam'\n[rank0]:[W316 22:26:28.541586886 ProcessGroupNCCL.cpp:1250] Warning: WARNING: process group has NOT been destroyed before we destruct ProcessGroupNCCL. On normal program exit, the application should call destroy_process_group to ensure that any pending NCCL operations have finished in this process. In rare cases this process can exit before this point and block the progress of another member of the process group. This constraint has always been present, but this warning has only been added since PyTorch 2.4 (function operator())\nts-8b1d81ee955ff3c80195834694934646-launcher:13362:13650 [0] NCCL INFO [Service thread] Connection closed by localRank 0\nts-8b1d81ee955ff3c80195834694934646-launcher:13362:13682 [0] NCCL INFO comm 0x148b95730 rank 0 nranks 1 cudaDev 0 busId 93000 - Abort COMPLETE\nE0316 22:26:30.194000 13297 site-packages/torch/distributed/elastic/multiprocessing/api.py:869] failed (exitcode: 1) local_rank: 0 (pid: 13362) of binary: /dockerdata/lujunda/env/rft/bin/python\nTraceback (most recent call last):\nFile \"/dockerdata/lujunda/env/rft/bin/torchrun\", line 8, in\nsys.exit(main())\n^^^^^^\nFile \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/distributed/elastic/multiprocessing/errors/init.py\", line 355, in wrapper\nreturn f(*args, **kwargs)\n^^^^^^^^^^^^^^^^^^\nFile \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/distributed/run.py\", line 919, in main\nrun(args)\nFile \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/distributed/run.py\", line 910, in run\nelastic_launch(\nFile \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/distributed/launcher/api.py\", line 138, in call\nreturn launch_agent(self._config, self._entrypoint, list(args))\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nFile \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/distributed/launcher/api.py\", line 269, in launch_agent\nraise ChildFailedError(\ntorch.distributed.elastic.multiprocessing.errors.ChildFailedError:\nsrc/virft/src/open_r1/grpo_classification.py FAILED\n",
    "comments_url": "https://api.github.com/repos/Liuziyu77/Visual-RFT/issues/106/comments",
    "author": "greasebig",
    "comments": [
      {
        "user": "Liuziyu77",
        "created_at": "2025-03-17T02:04:04Z",
        "body": "`#error \"You're trying to build PyTorch with a too old version of GCC. We need GCC 9 or later.\"`\nMaybe you should upgrade your GCC."
      },
      {
        "user": "greasebig",
        "created_at": "2025-03-17T02:37:17Z",
        "body": "thanks, it works. But new problem occurs:\n\n\ni run script \"2B_aircraft_4_shot.sh\"\n\n\n\n[2025-03-17 10:56:53,594] [INFO] [utils.py:789:see_memory_usage] CPU Virtual Memory:  used = 101.46 GB, percent = 10.1%\n[rank0]: Traceback (most recent call last):\n[rank0]:   File \"/apdcephfs_cq8/share_1534723/jackjdlu/ms_swift_custom/Visual-RFT/src/virft/src/open_r1/grpo_classification.py\", line 199, in <module>\n[rank0]:     main(script_args, training_args, model_args)\n[rank0]:   File \"/apdcephfs_cq8/share_1534723/jackjdlu/ms_swift_custom/Visual-RFT/src/virft/src/open_r1/grpo_classification.py\", line 175, in main\n[rank0]:     trainer = trainer_cls(\n[rank0]:               ^^^^^^^^^^^^\n[rank0]:   File \"/apdcephfs_cq8/share_1534723/jackjdlu/ms_swift_custom/Visual-RFT/src/virft/src/open_r1/trainer/grpo_trainer.py\", line 338, in __init__\n[rank0]:     self.ref_model = prepare_deepspeed(self.ref_model, self.accelerator)\n[rank0]:                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/trl/models/utils.py\", line 254, in prepare_deepspeed\n[rank0]:     model, *_ = deepspeed.initialize(model=model, config=config_kwargs)\n[rank0]:                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/__init__.py\", line 193, in initialize\n[rank0]:     engine = DeepSpeedEngine(args=args,\n[rank0]:              ^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/engine.py\", line 313, in __init__\n[rank0]:     self._configure_optimizer(optimizer, model_parameters)\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/engine.py\", line 1313, in _configure_optimizer\n[rank0]:     self.optimizer = self._configure_bf16_optimizer(basic_optimizer)\n[rank0]:                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/engine.py\", line 1518, in _configure_bf16_optimizer\n[rank0]:     optimizer = BF16_Optimizer(optimizer,\n[rank0]:                 ^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/bf16_optimizer.py\", line 98, in __init__\n[rank0]:     self._setup_for_real_optimizer()\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/bf16_optimizer.py\", line 141, in _setup_for_real_optimizer\n[rank0]:     self._flatten_dense_tensors_aligned(self.bf16_groups[i],\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/deepspeed/runtime/bf16_optimizer.py\", line 268, in _flatten_dense_tensors_aligned\n[rank0]:     return self.flatten(align_dense_tensors(tensor_list, alignment))\n[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]:   File \"/dockerdata/lujunda/env/rft/lib/python3.12/site-packages/torch/_utils.py\", line 519, in _flatten_dense_tensors\n[rank0]:     return torch._C._nn.flatten_dense_tensors(tensors)\n[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n[rank0]: RuntimeError: torch.cat(): expected a non-empty list of Tensors"
      }
    ],
    "satisfaction_conditions": [
      "A solution to upgrade or use a compatible GCC version (9 or later) for building PyTorch extensions",
      "Support for properly building and running the fused_adam extension in a DeepSpeed environment"
    ],
    "_classification": {
      "category": "Can be dockerized without any issue",
      "timestamp": "2025-04-14 01:05:16"
    },
    "dockerfile": "FROM nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04\n\n# Set environment variables\nENV DEBIAN_FRONTEND=noninteractive\nENV PATH=\"/usr/local/cuda/bin:${PATH}\"\nENV LD_LIBRARY_PATH=\"/usr/local/cuda/lib64:${LD_LIBRARY_PATH}\"\n\n# Install necessary packages\nRUN apt-get update && apt-get install -y \\\n    git \\\n    python3-dev \\\n    python3-pip \\\n    wget \\\n    ninja-build \\\n    build-essential \\\n    software-properties-common \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Install GCC 11 from Ubuntu 22.04 repositories\nRUN apt-get update && apt-get install -y gcc-11 g++-11 \\\n    && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 100 \\\n    && update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 100 \\\n    && update-alternatives --install /usr/bin/cc cc /usr/bin/gcc 100 \\\n    && update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++ 100 \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Create a working directory\nWORKDIR /app\n\n# Clone the repository and checkout the specific commit\nRUN git clone https://github.com/Liuziyu77/Visual-RFT.git . \\\n    && git checkout 384f47c1eb66f2fe76df5d330c11b9b481dd1791\n\n# Install Python dependencies\nRUN pip3 install --no-cache-dir --upgrade pip setuptools wheel \\\n    && pip3 install --no-cache-dir torch==2.0.1 torchvision==0.15.2 torchaudio==2.0.2 --index-url https://download.pytorch.org/whl/cu121 \\\n    && pip3 install --no-cache-dir transformers==4.34.0 diffusers==0.21.4 accelerate==0.23.0 \\\n    && pip3 install --no-cache-dir numpy scipy pillow matplotlib \\\n    && pip3 install --no-cache-dir deepspeed==0.11.2\n\n# Set environment variables for CUDA and compiler\nENV TORCH_CUDA_ARCH_LIST=\"8.0\"\nENV CUDA_HOME=\"/usr/local/cuda\"\nENV CC=/usr/bin/gcc-11\nENV CXX=/usr/bin/g++-11\nENV MAX_JOBS=4\n\n# Make sure GCC 11 is used for the build\nRUN ln -sf /usr/bin/gcc-11 /usr/bin/gcc \\\n    && ln -sf /usr/bin/g++-11 /usr/bin/g++\n\n# Build the project\nRUN cd src/virft && python3 setup.py build_ext --inplace\n\n# Set the working directory to the project root\nWORKDIR /app\n\n# The container will be ready for use\nCMD [\"/bin/bash\"]"
  }
]